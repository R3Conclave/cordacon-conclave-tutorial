


<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="shortcut icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-5.2.2">
    
    
      
        <title>Writing hello world - Conclave documentation</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.a2408e81.min.css">
      
        <link rel="stylesheet" href="assets/stylesheets/palette.a46bcfb3.min.css">
      
      
        
        
        <meta name="theme-color" content="#ef5350">
      
    
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
        
<link rel="preconnect dns-prefetch" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-87760032-7","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview")})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="red">
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#writing-the-sample-enclave" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="." title="Conclave documentation" class="md-header-nav__button md-logo" aria-label="Conclave documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Conclave documentation
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Writing hello world
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
        
      
      
        
          

  

<nav class="md-tabs md-tabs--active" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="index.html" class="md-tabs__link">
        Welcome
      </a>
    
  </li>

      
        
      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="architecture.html" class="md-tabs__link">
          Development
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="machine-setup.html" class="md-tabs__link">
          Operations
        </a>
      
    </li>
  

  

      
        
      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Conclave documentation" class="md-nav__button md-logo" aria-label="Conclave documentation">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Conclave documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="index.html" title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="enclaves.html" title="Enclaves" class="md-nav__link">
      Enclaves
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Development
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Development" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Development
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      Conclave architecture
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Conclave architecture" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Conclave architecture
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="architecture.html" title="Architecture" class="md-nav__link">
      Architecture
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="mail.html" title="Mail" class="md-nav__link">
      Mail
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="security.html" title="Security discussion" class="md-nav__link">
      Security discussion
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3-2" type="checkbox" id="nav-3-2" checked>
    
    <label class="md-nav__link" for="nav-3-2">
      Tutorial
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Tutorial" data-md-level="2">
      <label class="md-nav__title" for="nav-3-2">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Tutorial
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="tutorial.html" title="Compiling and running" class="md-nav__link">
      Compiling and running
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Writing hello world
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 9h14V7H3v2m0 4h14v-2H3v2m0 4h14v-2H3v2m16 0h2v-2h-2v2m0-10v2h2V7h-2m0 6h2v-2h-2v2z"/></svg>
        </span>
      </label>
    
    <a href="writing-hello-world.html" title="Writing hello world" class="md-nav__link md-nav__link--active">
      Writing hello world
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configure-your-modules" class="md-nav__link">
    Configure your modules
  </a>
  
    <nav class="md-nav" aria-label="Configure your modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#root-settingsgradle-file" class="md-nav__link">
    Root settings.gradle file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-buildgradle-file" class="md-nav__link">
    Root build.gradle file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-host-module" class="md-nav__link">
    Configure the host module
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-enclave-module" class="md-nav__link">
    Configure the enclave module
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-client-build" class="md-nav__link">
    Configure the client build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signing-keys" class="md-nav__link">
    Signing keys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-new-subclass-of-enclave" class="md-nav__link">
    Create a new subclass of Enclave
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-a-simple-host-program" class="md-nav__link">
    Write a simple host program
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remote-attestation" class="md-nav__link">
    Remote attestation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurating-attestation" class="md-nav__link">
    Configurating attestation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-what-weve-got-so-far" class="md-nav__link">
    Run what we've got so far
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encrypted-messaging" class="md-nav__link">
    Encrypted messaging
  </a>
  
    <nav class="md-nav" aria-label="Encrypted messaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#receiving-and-posting-mail-in-the-enclave" class="md-nav__link">
    Receiving and posting mail in the enclave
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiving-and-posting-mail-in-the-host" class="md-nav__link">
    Receiving and posting mail in the host
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-the-client" class="md-nav__link">
    Writing the client
  </a>
  
    <nav class="md-nav" aria-label="Writing the client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keys-and-mail" class="md-nav__link">
    Keys and mail
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mock" class="md-nav__link">
    Mock
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#native" class="md-nav__link">
    Native
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="api/index.html" title="API" class="md-nav__link">
      API
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Operations
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Operations" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Operations
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Server deployment
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M8.59 16.58L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.42z"/></svg>
      </span>
    </label>
    <nav class="md-nav" aria-label="Server deployment" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        <span class="md-nav__icon md-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
        </span>
        Server deployment
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="machine-setup.html" title="Machine setup" class="md-nav__link">
      Machine setup
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="ias.html" title="IAS" class="md-nav__link">
      IAS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="signing.html" title="Enclave signing" class="md-nav__link">
      Enclave signing
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="renewability.html" title="Renewability" class="md-nav__link">
      Renewability
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="faq.html" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#configure-your-modules" class="md-nav__link">
    Configure your modules
  </a>
  
    <nav class="md-nav" aria-label="Configure your modules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#root-settingsgradle-file" class="md-nav__link">
    Root settings.gradle file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#root-buildgradle-file" class="md-nav__link">
    Root build.gradle file
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-host-module" class="md-nav__link">
    Configure the host module
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-enclave-module" class="md-nav__link">
    Configure the enclave module
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configure-the-client-build" class="md-nav__link">
    Configure the client build
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#signing-keys" class="md-nav__link">
    Signing keys
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-a-new-subclass-of-enclave" class="md-nav__link">
    Create a new subclass of Enclave
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#write-a-simple-host-program" class="md-nav__link">
    Write a simple host program
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#remote-attestation" class="md-nav__link">
    Remote attestation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configurating-attestation" class="md-nav__link">
    Configurating attestation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#run-what-weve-got-so-far" class="md-nav__link">
    Run what we've got so far
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#encrypted-messaging" class="md-nav__link">
    Encrypted messaging
  </a>
  
    <nav class="md-nav" aria-label="Encrypted messaging">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#receiving-and-posting-mail-in-the-enclave" class="md-nav__link">
    Receiving and posting mail in the enclave
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#receiving-and-posting-mail-in-the-host" class="md-nav__link">
    Receiving and posting mail in the host
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-the-client" class="md-nav__link">
    Writing the client
  </a>
  
    <nav class="md-nav" aria-label="Writing the client">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#keys-and-mail" class="md-nav__link">
    Keys and mail
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing" class="md-nav__link">
    Testing
  </a>
  
    <nav class="md-nav" aria-label="Testing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mock" class="md-nav__link">
    Mock
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#native" class="md-nav__link">
    Native
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                  
                
                
                <h1 id="writing-the-sample-enclave">Writing the sample enclave<a class="headerlink" href="#writing-the-sample-enclave" title="Permanent link">&para;</a></h1>
<p>The sample "hello world" enclave just reverses whatever string is passed into it. We'll do these things to make 
our own version of the hello enclave project:</p>
<ol>
<li>Configure Gradle. At this time Conclave projects must use Gradle as their build system.</li>
<li>Implement an enclave object that accepts both local calls from the host, and encrypted messages from a client.</li>
<li>Write the host program that loads the enclave.</li>
<li>Run the host and enclave in simulation and debug modes.</li>
<li>Write the client that sends the enclave encrypted messages via the host.</li>
</ol>
<h2 id="configure-your-modules">Configure your modules<a class="headerlink" href="#configure-your-modules" title="Permanent link">&para;</a></h2>
<p>Create a new Gradle project via whatever mechanism you prefer, e.g. IntelliJ can do this via the New Project wizard.
Create three modules defined in the project: one for the host, one for the enclave and one for the client. </p>
<p>The host program may be an existing server program of some kind, e.g. a web server, but in this tutorial we'll 
write a command line host. The client may likewise be a GUI app or integrated with some other program (like a server), 
but in this case to keep it simple the client will also be a command line app.    </p>
<h3 id="root-settingsgradle-file">Root <code>settings.gradle</code> file<a class="headerlink" href="#root-settingsgradle-file" title="Permanent link">&para;</a></h3>
<p>In the unzipped SDK there is a directory called <code>repo</code> that contains a local Maven repository. This is where the libraries
and Gradle plugin can be found. We need to tell Gradle to look there for plugins.</p>
<p>Create or modify a file called <code>settings.gradle</code> in your project root directory so it looks like this:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">pluginManagement</span> <span class="o">{</span>
    <span class="n">repositories</span> <span class="o">{</span>
        <span class="n">maven</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">repoPath</span> <span class="o">=</span> <span class="n">file</span><span class="o">(</span><span class="n">rootDir</span><span class="o">.</span><span class="na">relativePath</span><span class="o">(</span><span class="n">file</span><span class="o">(</span><span class="n">conclaveRepo</span><span class="o">)))</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">repoPath</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s2">&quot;Make sure the &#39;conclaveRepo&#39; setting exists in gradle.properties, or your \$HOME/gradle.properties file. See the Conclave tutorial on https://docs.conclave.net&quot;</span><span class="o">)</span>
            <span class="k">else</span> <span class="nf">if</span> <span class="o">(!</span><span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="n">repoPath</span><span class="o">,</span> <span class="s2">&quot;com&quot;</span><span class="o">).</span><span class="na">isDirectory</span><span class="o">())</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">(</span><span class="s2">&quot;The $repoPath directory doesn&#39;t seem to exist or isn&#39;t a Maven repository; it should be the SDK &#39;repo&#39; subdirectory. See the Conclave tutorial on https://docs.conclave.net&quot;</span><span class="o">)</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">repoPath</span>
        <span class="o">}</span>
        <span class="c1">// Add standard repositories back.</span>
        <span class="n">gradlePluginPortal</span><span class="o">()</span>
        <span class="n">jcenter</span><span class="o">()</span>
        <span class="n">mavenCentral</span><span class="o">()</span>
    <span class="o">}</span>

    <span class="n">plugins</span> <span class="o">{</span>
        <span class="n">id</span> <span class="s1">&#39;com.r3.conclave.enclave&#39;</span> <span class="n">version</span> <span class="n">conclaveVersion</span> <span class="n">apply</span> <span class="kc">false</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">include</span> <span class="s1">&#39;enclave&#39;</span>
<span class="n">include</span> <span class="s1">&#39;host&#39;</span>
</code></pre></div>
</td></tr></table>
<p>This boilerplate is unfortunately necessary to copy/paste into each project that uses Conclave. It sets up Gradle to
locate the plugin that configures the rest of the boilerplate build logic for you <img alt="😉" class="twemoji" src="https://twemoji.maxcdn.com/v/latest/svg/1f609.svg" title=":wink:" /></p>
<p>The <code>pluginManagement</code> block tells Gradle to use a property called <code>conclaveRepo</code> to find the <code>repo</code> directory
in your SDK download. Because developers on your team could unpack the SDK anywhere, they must configure the path
before the build will work. The code above will print a helpful error if they forget or get it wrong.</p>
<p>To set the value a developer can add to <a href="https://docs.gradle.org/current/userguide/organizing_gradle_projects.html#declare_properties_in_gradle_properties_file">the <code>gradle.properties</code> file</a>
a couple of lines like this:</p>
<table class="text codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="text codehilite"><pre><span></span><code>conclaveRepo=/path/to/sdk/repo
conclaveVersion=0.3
</code></pre></div>
</td></tr></table>
<p>0.3 here means use beta 3.</p>
<p>Gradle properties can be set using a file in the project directory, or more usefully in the developer's home directory.
You may wish to put the version in the project's <code>gradle.properties</code> file and the path in each developer's personal
<code>gradle.properties</code>. Alternatively just add a <code>sdk</code> directory to the <code>.gitignore</code> and require everyone to unpack the
SDK to the source tree. </p>
<h3 id="root-buildgradle-file">Root <code>build.gradle</code> file<a class="headerlink" href="#root-buildgradle-file" title="Permanent link">&para;</a></h3>
<p>Add the following code to your root <code>build.gradle</code> file to import the repository:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">plugins</span> <span class="o">{</span>
    <span class="n">id</span> <span class="s1">&#39;java&#39;</span>
    <span class="n">id</span> <span class="s1">&#39;idea&#39;</span>
<span class="o">}</span>

<span class="n">idea</span> <span class="o">{</span>
    <span class="n">module</span> <span class="o">{</span>
        <span class="n">downloadJavadoc</span> <span class="o">=</span> <span class="kc">true</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="n">subprojects</span> <span class="o">{</span>
    <span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">&#39;idea&#39;</span>

    <span class="n">idea</span> <span class="o">{</span>
        <span class="n">module</span> <span class="o">{</span>
            <span class="n">downloadJavadoc</span> <span class="o">=</span> <span class="kc">true</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="hll">    <span class="n">repositories</span> <span class="o">{</span>
</span><span class="hll">        <span class="n">maven</span> <span class="o">{</span>
</span><span class="hll">            <span class="n">url</span> <span class="o">=</span> <span class="n">rootProject</span><span class="o">.</span><span class="na">file</span><span class="o">(</span><span class="n">conclaveRepo</span><span class="o">)</span>
</span><span class="hll">        <span class="o">}</span>
</span><span class="hll">        <span class="n">mavenCentral</span><span class="o">()</span>
</span><span class="hll">    <span class="o">}</span>
</span><span class="o">}</span>
</code></pre></div>
</td></tr></table>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Most of this boilerplate isn't strictly necessary except for the highlighted region. However, the rest works around
<a href="https://youtrack.jetbrains.com/issue/IDEA-231254">a bug in IntelliJ IDEA</a> if you wish to use that IDE in which 
interactive JavaDocs would otherwise not be available. To benefit from the workaround you should run <code>./gradlew idea</code>
to generate your IntelliJ project. If IntelliJ is running at the time it should automatically notice the changes and
apply them. If you click "import from Gradle" in the notification popup workflow then everything will work fine 
except JavaDoc integration.</p>
</div>
<h3 id="configure-the-host-module">Configure the host module<a class="headerlink" href="#configure-the-host-module" title="Permanent link">&para;</a></h3>
<p>SGX enclaves can be used in one of four modes, in order of increasing realism: </p>
<ol>
<li>Mock: your enclave class is created in the host JVM and no native or SGX specific code is used.</li>
<li>Simulation: an enclave is compiled to native and loaded, but SGX hardware doesn't need to be present.</li>
<li>Debug: the enclave is loaded using SGX hardware and drivers, but with a back door that allows debugger access to the memory.</li>
<li>Release: the enclave is loaded using SGX hardware and drivers, and there's no back door. This is the real deal.</li>
</ol>
<p>Only release mode locks out the host and provides the standard SGX security model. At this time it requires the 
enclave to be <a href="signing.html">signed</a> with a key whitelisted by Intel. Future versions of Conclave will remove this
restriction for modern hardware that supports <em>flexible launch control</em>. </p>
<p>Add this bit of code to your host <code>build.gradle</code> file to let the mode be chosen from the command line:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="c1">// Override the default (simulation) with -PenclaveMode=</span>
<span class="kt">def</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">findProperty</span><span class="o">(</span><span class="s2">&quot;enclaveMode&quot;</span><span class="o">)?.</span><span class="na">toString</span><span class="o">()?.</span><span class="na">toLowerCase</span><span class="o">()</span> <span class="o">?:</span> <span class="s2">&quot;simulation&quot;</span>
</code></pre></div>
</td></tr></table>
<p>Then add the following dependencies, also to the host's <code>build.gradle</code>:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s2">&quot;com.r3.conclave:conclave-host:$conclaveVersion&quot;</span>
    <span class="n">runtimeOnly</span> <span class="nf">project</span><span class="o">(</span><span class="nl">path:</span> <span class="s2">&quot;:enclave&quot;</span><span class="o">,</span> <span class="nl">configuration:</span> <span class="n">mode</span><span class="o">)</span>

    <span class="n">runtimeOnly</span> <span class="s2">&quot;org.slf4j:slf4j-simple:1.7.30&quot;</span>
    <span class="n">testImplementation</span> <span class="s2">&quot;org.junit.jupiter:junit-jupiter:5.6.0&quot;</span>
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
<p>This says that at runtime (but not compile time) the <code>:enclave</code> module must be on the classpath, and configures 
dependencies to respect the three different variants of the enclave. That is, the enclave module will expose tasks
to compile and use either simulation, debug or release mode (in mock mode you're just using regular Java, so no
special compilation is necessary). Which task to use is actually selected by the host build. </p>
<p>For this simple tutorial we also add a runtime-only dependency on the popular <a href="https://www.slf4j.org">SLF4J</a> library 
which Conclave uses to do logging. SLF4J enables you to send Conclave's logging to any of the major logging frameworks 
used in Java, but here, we add the "simple" backend which just causes it to log to the console. Finally we configure 
unit testing using JUnit 5.</p>
<p>If you intend to use an <a href="signing.html">external signing process</a> to sign your enclave then add the following lines to
the Gradle file:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="c1">// Create a task that can be used for generating signing materials</span>
<span class="n">tasks</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="s2">&quot;prepareForSigning&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">it</span><span class="o">.</span><span class="na">dependsOn</span><span class="o">(</span><span class="s2">&quot;:enclave:generateEnclaveSigningMaterial&quot;</span> <span class="o">+</span> <span class="n">mode</span><span class="o">.</span><span class="na">capitalize</span><span class="o">())</span>
<span class="o">}</span>    
</code></pre></div>
</td></tr></table>
<p>This creates a new task that can be invoked using Gradle to halt the build after generating materials that need to
be signed by an external signing process. After the material has been signed the build can be resumed.</p>
<h3 id="configure-the-enclave-module">Configure the enclave module<a class="headerlink" href="#configure-the-enclave-module" title="Permanent link">&para;</a></h3>
<p>Add the Conclave Gradle plugin:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">plugins</span> <span class="o">{</span>
<span class="hll">    <span class="n">id</span> <span class="s1">&#39;com.r3.conclave.enclave&#39;</span>
</span><span class="o">}</span>
</code></pre></div>
</td></tr></table>
<p>and a dependency on the Conclave enclave library:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">dependencies</span> <span class="o">{</span>
<span class="hll">    <span class="n">implementation</span> <span class="s2">&quot;com.r3.conclave:conclave-enclave&quot;</span>
</span>    <span class="n">testImplementation</span> <span class="s2">&quot;com.r3.conclave:conclave-testing&quot;</span>
    <span class="n">testImplementation</span> <span class="s2">&quot;org.junit.jupiter:junit-jupiter:5.6.0&quot;</span>
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
<p>This time you don't have to specify the Conclave version because the plugin will set that for you automatically.</p>
<p>Specify the enclave's runtime environment, product ID and revocation level:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">conclave</span> <span class="o">{</span>
    <span class="n">runtime</span> <span class="o">=</span> <span class="n">graalvm_native_image</span>
    <span class="n">productID</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">revocationLevel</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
<p>The runtime setting tells Conclave which runtime environment to use inside the enclave and can either be <code>avian</code> or
<code>graalvm_native_image</code>. If the setting is omitted then it defaults to <code>graalvm_native_image</code>. See
<a href="architecture.html">Architecture overview</a> for details on the differences between the two supported runtime
environments. The <code>graalvm_native_image</code> value is new and has a few limitations, but runs much faster. </p>
<p>Conclave needs access to a Linux build environment in order to build enclaves with the <code>graalvm_native_image</code> runtime. 
On MacOS and Windows this is automatically created during the build process using Docker. If you do not have Docker
installed then the build will generate an error prompting you to switch to using either the <code>avian</code> runtime or to
install Docker on your system. Once Docker is installed and added to your <code>PATH</code> environment variable you can proceed
to build <code>graalvm_native_image</code> enclaves. Docker is not required for enclaves using the <code>avian</code> runtime.</p>
<p>The product ID is an arbitrary number that can be used to distinguish between different enclaves produced by the same
organisation (which may for internal reasons wish to use a single signing key). This value should not change once you
picked it.</p>
<p>The revocation level should be incremented if a weakness in the enclave code discovered and fixed; doing this will enable
clients to avoid connecting to old, compromised enclaves. The revocation level should not be incremented on every new
release, but only when security improvements have been made.</p>
<p>Specify the signing methods for each of the build types. You could keep your private key in a file for both debug and
release enclaves if you like, but some organisations require private keys to be held in an offline system or HSM. In
that case, configure it like this:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">conclave</span> <span class="o">{</span>
    <span class="n">productID</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">revocationLevel</span> <span class="o">=</span> <span class="mi">0</span>

<span class="hll">    <span class="c1">// For simulation, we want to use the default signing type of dummyKey so</span>
</span><span class="hll">    <span class="c1">// we do not need to specify a configuration.</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">debug</span> <span class="o">{</span>
</span><span class="hll">        <span class="n">signingType</span> <span class="o">=</span> <span class="n">privateKey</span>
</span><span class="hll">        <span class="n">signingKey</span> <span class="o">=</span> <span class="n">file</span><span class="o">(</span><span class="s2">&quot;../signing/sample_private_key.pem&quot;</span><span class="o">)</span>
</span><span class="hll">    <span class="o">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">release</span> <span class="o">{</span>
</span><span class="hll">        <span class="c1">// To protect our release private key with an HSM, the enclave needs to be built in stages.</span>
</span><span class="hll">        <span class="c1">// Firstly, build the signing material:</span>
</span><span class="hll">        <span class="c1">//  ./gradlew prepareForSigning -PenclaveMode=&quot;Release&quot;</span>
</span><span class="hll">        <span class="c1">//</span>
</span><span class="hll">        <span class="c1">// Generate a signature from the signing material.</span>
</span><span class="hll">        <span class="c1">//</span>
</span><span class="hll">        <span class="c1">// Finally build the signed enclave:</span>
</span><span class="hll">        <span class="c1">//  ./gradlew build -PenclaveMode=&quot;Release&quot;</span>
</span><span class="hll">        <span class="c1">//</span>
</span><span class="hll">        <span class="n">signingType</span> <span class="o">=</span> <span class="n">externalKey</span>
</span><span class="hll">        <span class="n">signatureDate</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="mi">1970</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
</span><span class="hll">        <span class="n">mrsignerSignature</span> <span class="o">=</span> <span class="n">file</span><span class="o">(</span><span class="s2">&quot;../signing/signature.bin&quot;</span><span class="o">)</span>
</span><span class="hll">        <span class="n">mrsignerPublicKey</span> <span class="o">=</span> <span class="n">file</span><span class="o">(</span><span class="s2">&quot;../signing/external_signing_public.pem&quot;</span><span class="o">)</span>
</span><span class="hll">    <span class="o">}</span>
</span>
    <span class="n">runtime</span> <span class="o">=</span> <span class="n">graalvm_native_image</span>
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="configure-the-client-build">Configure the client build<a class="headerlink" href="#configure-the-client-build" title="Permanent link">&para;</a></h3>
<p>The client build is the simplest of all. This is literally a bog-standard hello world command line app Gradle build,
with a single dependency on the Conclave client library:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">plugins</span> <span class="o">{</span>
    <span class="n">id</span> <span class="s1">&#39;java&#39;</span>
    <span class="n">id</span> <span class="s1">&#39;application&#39;</span>
<span class="o">}</span>

<span class="n">application</span> <span class="o">{</span>
    <span class="n">mainClassName</span> <span class="o">=</span> <span class="s2">&quot;com.r3.conclave.sample.client.Client&quot;</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">implementation</span> <span class="s2">&quot;com.r3.conclave:conclave-client:$conclaveVersion&quot;</span>
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
<p>And with that, we're done configuring the build.</p>
<h3 id="signing-keys">Signing keys<a class="headerlink" href="#signing-keys" title="Permanent link">&para;</a></h3>
<p>The example configuration above specifies different <a href="signing.html#signing-configurations">signing configurations</a> for 
each of the different build types. </p>
<ul>
<li>Simulation builds use the default dummy key. </li>
<li>Debug builds use a private key stored in a file.</li>
<li>Release builds use a private key managed by some external signing process.</li>
</ul>
<p>The <code>hello-world</code> sample in the SDK contains some example keys that can be used with the <code>privateKey</code>
and <code>externalKey</code> signing types. These can be found in <code>hello-world/signing/</code>.</p>
<table>
<thead>
<tr>
<th align="left">Key Files</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">sample_private_key.pem</td>
<td align="left">A 3072 bit RSA private key that can be used to test the <code>privateKey</code> signing type</td>
</tr>
<tr>
<td align="left">external_signing_*.pem</td>
<td align="left">An AES encrypted 3072 bit RSA public/private key pair that can be used to test the <code>externalKey</code> signing type. The private key can be accessed with the password '12345'</td>
</tr>
</tbody>
</table>
<p>Alternatively you can provide or <a href="signing.html#generating-keys-for-signing-an-enclave">generate your own</a> keys.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>These keys aren't whitelisted by Intel so you can't use them for real release builds.
Only use these sample keys for the tutorial. Don't use them for signing your own enclaves!</p>
</div>
<h2 id="create-a-new-subclass-of-enclave">Create a new subclass of <code>Enclave</code><a class="headerlink" href="#create-a-new-subclass-of-enclave" title="Permanent link">&para;</a></h2>
<p>Enclaves are similar to standalone programs and as such have an equivalent to a "main class". This class must be a
subclass of <a href="/api/com/r3/conclave/enclave/Enclave.html"><code>Enclave</code></a>.</p>
<p>Create your enclave class:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="kn">package</span> <span class="nn">com.superfirm.enclave</span><span class="p">;</span>   <span class="c1">// CHANGE THIS</span>

<span class="kn">import</span> <span class="nn">com.r3.conclave.enclave.Enclave</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Simply reverses the bytes that are passed in.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReverseEnclave</span> <span class="kd">extends</span> <span class="n">Enclave</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">receiveFromUntrustedHost</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytes</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
            <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">[</span><span class="n">bytes</span><span class="p">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="o">]</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>The <code>Enclave</code> class by itself doesn't require you to support direct communication with the host. This is because
sometimes you don't need that and shouldn't have to implement message handlers. In this case we'll use that
functionality because it's a good place to start learning, so we also override and implement the <code>receiveFromUntrustedHost</code>
method which takes a byte array and optionally returns a byte array back. Here we just reverse the contents.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In a real app you would use the byte array to hold serialised data structures. You can use whatever data formats you
like. You could use a simple string format or a binary format like protocol buffers.</p>
</div>
<h2 id="write-a-simple-host-program">Write a simple host program<a class="headerlink" href="#write-a-simple-host-program" title="Permanent link">&para;</a></h2>
<p>An enclave by itself is just a library: you must therefore load it from inside a host program.</p>
<p>It's easy to load then pass data to and from an enclave. Let's start with the skeleton of a little command line app:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * This class demonstrates how to load an enclave and use it.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Host</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">EnclaveLoadException</span> <span class="p">{</span>
        <span class="c1">// TODO: Fill this out</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">callEnclave</span><span class="p">(</span><span class="n">EnclaveHost</span> <span class="n">enclave</span><span class="p">,</span> <span class="n">String</span> <span class="n">input</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// TODO: Fill this out.</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>At first we will be building and running our enclave in simulation mode. This does not require the platform 
hardware to support SGX. However simulation mode does require us to be using Linux. If we are not using 
Linux as our host OS then we can use a Linux container or virtual machine. Alternatively we could
use <a href="writing-hello-world.html#mock">mock mode</a> instead of simulation mode. When we want to switch to loading
either a debug or release build of the enclave we need to ensure the platform supports SGX.</p>
<p>By adding the code below to the main method we can determine whether the platform can load debug and release 
enclaves. This method reports the actual hardware status even if you are currently working with simulation 
enclaves.</p>
<p>If SGX is not supported the function throws an exception which describes the reason why. There are a number of 
common reasons why SGX may not be supported including:</p>
<ol>
<li>The CPU or the system BIOS does not support SGX.</li>
<li>The host operating system is Windows or Mac OS. Conclave currently only supports loading
   enclaves in simulation, debug or release modes on Linux.</li>
<li>SGX is disabled in the BIOS and must be manually enabled by the user.</li>
<li>SGX is disabled but can be enabled in software.</li>
</ol>
<p>If SGX is disabled but can be enabled in software the code below attempts to automatically enable SGX support 
by specifying the 'true' parameter. It might be necessary to run this application with root access and/or reboot 
the system in order to successfully enable SGX. The exception message will describe if this is the case.</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code>        <span class="k">try</span> <span class="p">{</span>
            <span class="n">EnclaveHost</span><span class="p">.</span><span class="na">checkPlatformSupportsEnclaves</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;This platform supports enclaves in simulation, debug and release mode.&quot;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">EnclaveLoadException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;This platform does not support hardware enclaves: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="p">.</span><span class="na">getMessage</span><span class="p">());</span>
        <span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>To load the enclave we'll put this after the platform check:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="s">&quot;com.r3.conclave.sample.enclave.ReverseEnclave&quot;</span><span class="p">;</span>
<span class="k">try</span> <span class="p">(</span><span class="n">EnclaveHost</span> <span class="n">enclave</span> <span class="o">=</span> <span class="n">EnclaveHost</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="n">className</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">enclave</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">callEnclave</span><span class="p">(</span><span class="n">enclave</span><span class="p">,</span> <span class="s">&quot;Hello world!&quot;</span><span class="p">));</span>
    <span class="c1">// !dlrow olleH      :-)</span>

    <span class="c1">// TODO: Get the remote attestation</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>This code starts by creating an <a href="api/com/r3/conclave/host/EnclaveHost.html"><code>EnclaveHost</code></a> object. This names the 
class and then attempts to load it inside another JVM running inside an enclave. A remote attestation procedure is
then performed involving Intel's servers. This procedure can fail if attempting to load a debug or release enclave 
and the platform does not support SGX. This is why it is important to perform the platform check we made in the code 
above. If the enclave does fail to load for any reason then an exception is thrown describing the reason why.</p>
<p>We then call <code>start</code> which initialises the enclave and the <code>MyEnclave</code> class inside it.
You can load multiple enclaves at once but they must all use same mode, and each enclave will get its own isolated
JVM.</p>
<p>Note that an <code>EnclaveHost</code> allocates memory out of a pool called the "enclave page cache" which is a machine-wide
limited resource. It'll be freed if the host JVM quits, but it's good practice to close the <code>EnclaveHost</code> object by
calling <code>close</code> on it when done. Therefore we also make sure the <code>.close()</code> method is called on the enclave no
matter what using a try-with-resources statement. This doesn't actually matter in such a tiny hello world sample,
because the enclave will be unloaded by the kernel once we exit like any other resource. It's just here to remind
you that an enclave must be explicitly unloaded if you need to reinitialise it for whatever reason, or if you need
the memory back.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Starting and stopping/closing an enclave is not free, so <strong>don't</strong> load the enclave, use it and immediately close it 
again as in the above example. Cost-wise it's like starting a regular process even though no process will actually 
exist. Treat the enclave like any other expensive resource and keep it around for as long as you might need it.</p>
</div>
<p>Once we started the enclave, we call it passing in a string as bytes. The enclave will reverse it and we'll print out
the answer. This is as easy as calling <code>EnclaveHost.callEnclave</code>, so put this in the <code>callEnclave</code> static method
defined above:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="c1">// We&#39;ll convert strings to bytes and back.</span>
<span class="k">return</span> <span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">enclave</span><span class="p">.</span><span class="na">callEnclave</span><span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="na">getBytes</span><span class="p">()));</span>
</code></pre></div>
</td></tr></table>
<p>So we just convert the string to bytes, send it to the enclave, and convert the response from bytes back to a string.</p>
<h2 id="remote-attestation">Remote attestation<a class="headerlink" href="#remote-attestation" title="Permanent link">&para;</a></h2>
<p>There's no point in using an enclave to protect purely local data, as the data must ultimately come from the
(assumed malicious/compromised) host in that scenario. That's why you need remote attestation, which lets an enclave 
prove its identity to the third parties who will upload secret data. If this paragraph doesn't make
sense please review the <a href="architecture.html">Architecture overview</a> and the <a href="enclaves.html">enclaves</a> section.</p>
<p>Before we can set up communication with a client, we must therefore get remote attestation working.</p>
<p>Using remote attestation is easy! Just obtain an <code>EnclaveInstanceInfo</code> and serialize/deserialize it using the
provided methods. There's a useful <code>toString</code> method: </p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="kd">final</span> <span class="n">EnclaveInstanceInfo</span> <span class="n">attestation</span> <span class="o">=</span> <span class="n">enclave</span><span class="p">.</span><span class="na">getEnclaveInstanceInfo</span><span class="p">();</span>
<span class="kd">final</span> <span class="kt">byte</span><span class="o">[]</span> <span class="n">attestationBytes</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="na">serialize</span><span class="p">();</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">EnclaveInstanceInfo</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">attestationBytes</span><span class="p">));</span>
</code></pre></div>
</td></tr></table>
<p>That will print out something like this:</p>
<table class="text codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="text codehilite"><pre><span></span><code>Remote attestation for enclave F86798C4B12BE12073B87C3F57E66BCE7A541EE3D0DDA4FE8853471139C9393F:
  - Mode: SIMULATION
  - Code signing key hash: 01280A6F7EAC8799C5CFDB1F11FF34BC9AE9A5BC7A7F7F54C77475F445897E3B
  - Public signing key: 302A300506032B65700321000568034F335BE25386FD405A5997C25F49508AA173E0B413113F9A80C9BBF542
  - Public encryption key: A0227D6D11078AAB73407D76DB9135C0D43A22BEACB0027D166937C18C5A7973
  - Product ID: 1
  - Revocation level: 0

Assessed security level at 2020-07-17T16:31:51.894697Z is INSECURE
  - Enclave is running in simulation mode.
</code></pre></div>
</td></tr></table>
<p>The hash in the first line is the <em>measurement</em>. This is a hash of the code of the enclave. It includes both all
the Java code inside the enclave as a fat-JAR, and all the support and JVM runtime code required. As such it will
change any time you alter the code of your enclave, the version of Conclave in use or the mode
(simulation/debug/release) of the enclave. The enclave measurement should be stable across builds and machines, so
clients can audit the enclave by repeating the Gradle build and comparing the value they get in the
<code>EnclaveInstanceInfo</code> against what the build process prints out.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<ol>
<li>All this data is available via individual getters on the <code>EnclaveInstanceInfo</code> so you should never feel a need to
   parse the output of <code>toString</code>.</li>
<li><code>EnclaveInstanceInfo</code> is an interface so you can easily build mock attestations in your tests.</li>
<li>When not in simulation mode the timestamp is signed by Intel and comes from their servers. </li>
</ol>
</div>
<p>An instance has a security assessment, which can change in response to discovery of vulnerabilities in the
infrastructure (i.e. without anything changing about the host or enclave itself). As we can see this enclave isn't
actually considered secure yet because we're running in simulation mode still. An enclave can be <code>SECURE</code>, <code>STALE</code>, 
or <code>INSECURE</code>. A assessment of <code>STALE</code> means there is a software/firmware/microcode update available for the platform
that improves security in some way. The client may wish to observe when this starts being reported and define a 
time span in which the remote enclave operator must upgrade.</p>
<p>Now get the serialized bytes to a client via whatever network mechanism you want. The bytes are essentially a large,
complex digital signature, so it's safe to publish them publicly. An attestation doesn't inherently expire but because 
the SGX ecosystem is always moving, client code will typically have some frequency with which it expects the host code
to refresh the <code>EnclaveInstanceInfo</code>. At present this is done by stopping/closing and then restarting the enclave.</p>
<h2 id="configurating-attestation">Configurating attestation<a class="headerlink" href="#configurating-attestation" title="Permanent link">&para;</a></h2>
<p>To use SGX remote attestation for real we need to do some additional work. Remember how we wrote 
<code>enclave.start(null, null);</code> above? The first parameter contains configuration data required to use an attestation
service. There are three kinds of attestation service:</p>
<ol>
<li>EPID. This older protocol is supported by some desktop/laptop class Intel CPUs. The EPID protocol includes some
   consumer privacy cryptography, and involves talking directly to Intel's IAS service to generate an attestation.
   For that you need to obtain an API key and service provider ID from Intel. You can sign-up easily and for free. 
   <a href="ias.html">Learn more about IAS</a>.</li>
<li>Azure DCAP. The <em>datacenter attestation primitives</em> protocol is newer and designed for servers. When running on a
   Microsoft Azure Confidential Compute VM or Kubernetes pod, you don't need any parameters. It's all configured out of 
   the box.</li>
<li>Generic DCAP. When not running on Azure, you need to obtain API keys for Intel's PCCS service. </li>
</ol>
<p>We'll target Azure for now to keep things simple. Replace the call to <code>EnclaveHost.start</code> above with this snippet:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="n">enclave</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">new</span> <span class="n">AttestationParameters</span><span class="p">.</span><span class="na">DCAP</span><span class="p">(),</span> <span class="kc">null</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Why does Conclave need to contact Intel's servers? It's because those servers contain the most up to date information
about what CPUs and system enclave versions are considered secure. Over time these servers will change their 
assessment of the host system and this will be visible in the responses, as security improvements are made.  </p>
</div>
<h2 id="run-what-weve-got-so-far">Run what we've got so far<a class="headerlink" href="#run-what-weve-got-so-far" title="Permanent link">&para;</a></h2>
<p>We can apply the Gradle <code>application</code> plugin and set the <code>mainClassName</code> property
<a href="https://docs.gradle.org/current/userguide/application_plugin.html#application_plugin">in the usual manner</a> to let us run
the host from the command line.</p>
<p>Now run <code>gradlew host:run</code> and it should print "Hello World!" backwards along with the security info as shown above.</p>
<p>During the build you should see output like this:</p>
<table class="text codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="text codehilite"><pre><span></span><code>&gt; Task :enclave:generateEnclaveletMetadataSimulation
Succeed.
Enclave measurement: 04EDA32215B496C3890348752F47D77DC34989FE4ECACCF5EC5C054F1D68BBE6
</code></pre></div>
</td></tr></table>
<p>The measurement should correspond to the value found in the <code>EnclaveInstanceInfo.getCodeHash()</code> property.</p>
<p>You can switch to debug mode by specifying the <code>enclaveMode</code> property. In debug mode the real hardware is used and 
virtually everything is identical to how it will be in production, but there's a small back door that can be used 
by debuggers to read/write the enclave's memory. </p>
<p>You will need to run this on an <a href="https://docs.microsoft.com/en-us/azure/confidential-computing/">Azure Confidential VM</a>.</p>
<p><code>gradlew -PenclaveMode=debug host:run</code></p>
<h2 id="encrypted-messaging">Encrypted messaging<a class="headerlink" href="#encrypted-messaging" title="Permanent link">&para;</a></h2>
<p>The enclave isn't of much use to the host, because the host already trusts itself. It's only useful to remote clients
that want to use the enclave for computation without having to trust the host machine or software.</p>
<p>We're now going to wire up encrypted messaging. Conclave provides an API for this called Mail. Conclave Mail handles all the
encryption for you, but leaves it up to you how the bytes themselves are moved around. You could use a REST API, a gRPC
API, JMS message queues, a simple TCP socket as in this tutorial, or even files.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p><a href="architecture.html#mail">Learn more about the design of Conclave Mail</a>, and <a href="mail.html">compare it to TLS</a>.</p>
</div>
<h3 id="receiving-and-posting-mail-in-the-enclave">Receiving and posting mail in the enclave<a class="headerlink" href="#receiving-and-posting-mail-in-the-enclave" title="Permanent link">&para;</a></h3>
<p>Firstly we need to upgrade our little enclave to be able to receive mails from clients. This is easy! Just override
the <code>receiveMail</code> method:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * Simply reverses the bytes that are passed in.</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReverseEnclave</span> <span class="kd">extends</span> <span class="n">Enclave</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">receiveFromUntrustedHost</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">bytes</span><span class="p">.</span><span class="na">length</span><span class="o">]</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bytes</span><span class="p">.</span><span class="na">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">result</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">bytes</span><span class="o">[</span><span class="n">bytes</span><span class="p">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="o">]</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="nd">@Override</span>
</span><span class="hll">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">receiveMail</span><span class="p">(</span><span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="n">EnclaveMail</span> <span class="n">mail</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="kt">byte</span><span class="o">[]</span> <span class="n">reversed</span> <span class="o">=</span> <span class="n">receiveFromUntrustedHost</span><span class="p">(</span><span class="n">mail</span><span class="p">.</span><span class="na">getBodyAsBytes</span><span class="p">());</span>
</span><span class="hll">        <span class="n">MutableMail</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">createMail</span><span class="p">(</span><span class="n">mail</span><span class="p">.</span><span class="na">getAuthenticatedSender</span><span class="p">(),</span> <span class="n">reversed</span><span class="p">);</span>
</span><span class="hll">        <span class="n">postMail</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p>The <code>receiveFromUntrustedHost</code> method here isn't really needed, it's just because we're already using this to demonstrate local calls.
The new part is <code>receiveMail</code>. This method takes two parameters: an identifier that the host gets to pick, which doesn't
mean anything but we can use to acknowledge the mail if we want to using <code>Enclave.acknowledgeMail</code>. Acknowledgement can be used
to tell the host the enclave is done processing the mail if it doesn't want to reply immediately. It will be discussed
more in future tutorials. In this simple tutorial we reply immediately so don't need to use this feature, and thus we
ignore the ID.</p>
<p>The second parameter is an <code>EnclaveMail</code>. This object gives us access to the body bytes that the client sent, but it
also exposes some other header fields:</p>
<ol>
<li>The <em>authenticated sender public key</em>. This is the public key of the client that sent the mail. It's called 
   "authenticated" because the encryption used by Conclave means you can trust that the mail was encrypted by an entity
   holding the private key matching this public key. If your enclave recognises the public key this feature can be used
   as a form of user authentication.</li>
<li>A <em>topic</em>. This can be used to distinguish between different streams of mail from the same client. It's a string and
   can be thought of as equivalent to a URL path or port number.</li>
<li>The <em>from field</em>. This is a string that the sender can pick to identify itself. Unlike the authenticated sender key
   this is entirely arbitrary, and nothing stops a sender picking any value it likes. Often this field won't be used.
   It's intended to hold some sort of routing address where the sender would like to receive replies - sometimes this
   is implied, but an explicit routing address can be useful when implementing more complex hosts and enclave that may
   not reply straight away.</li>
<li>The <em>envelope</em>. This is a slot that can hold any arbitrary byte array the sender likes. It's a holding zone for 
   app specific data that should be authenticated but unencrypted.</li>
<li>The <em>sequence number</em>. This must increment by one for every mail delivered on a topic. Conclave will automatically 
   reject messages for which this doesn't hold true, within the scope of messages seen whilst the enclave is loaded.</li>
</ol>
<p><strong>These header fields are available to the host and therefore should not contain secrets</strong>. It may seem odd to have
data that's unencrypted, but it's often useful for the client, host and enclave to collaborate in various ways related
to storage and routing of data. Even when the host is untrusted it may still be useful for the client to send data
that is readable by the host and enclave simultaneously, but which the host cannot tamper with. Inside the enclave
you can be assured that the header fields contain the values set by the client, because they're checked before 
<code>receiveMail</code> is invoked.</p>
<p>In this simple tutorial we only care about the body and sender public key. We reverse the bytes in the mail body
and then create a response mail that will be encrypted to the sender. It contains the reversed bytes. We use the
<code>createMail</code> method to do this. It gives us back a <code>MutableMail</code> object, which is a builder with setters we can use 
to control the sequence number, topic and so on. Once we've done configuring it to our liking we pass it to
<code>postMail</code> which performs the encryption and delivers the newly encrypted mail to the host. It will emerge in a callback
we're about to configure.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can post mail anytime and to anyone you like. It doesn't have to be a response to the sender, you can post
multiple mails at once and you can post mails inside <code>receiveFromUntrustedHost</code> (i.e. during a local call).</p>
</div>
<h3 id="receiving-and-posting-mail-in-the-host">Receiving and posting mail in the host<a class="headerlink" href="#receiving-and-posting-mail-in-the-host" title="Permanent link">&para;</a></h3>
<p>Mail posted by an enclave appears in a callback we pass to <code>EnclaveHost.start</code>. Let's use a really simple 
implementation: we'll just store the encrypted bytes in a variable, so we can pick it up later:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="c1">// Start it up.</span>
<span class="n">AtomicReference</span><span class="o">&lt;</span><span class="kt">byte</span><span class="o">[]&gt;</span> <span class="n">mailToSend</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AtomicReference</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="n">enclave</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="n">attestationParameters</span><span class="p">,</span> <span class="k">new</span> <span class="n">EnclaveHost</span><span class="p">.</span><span class="na">MailCallbacks</span><span class="p">()</span> <span class="p">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">postMail</span><span class="p">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">encryptedBytes</span><span class="p">,</span> <span class="n">String</span> <span class="n">routingHint</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mailToSend</span><span class="p">.</span><span class="na">set</span><span class="p">(</span><span class="n">encryptedBytes</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre></div>
</td></tr></table>
<p>Java doesn't let us directly change variables from a callback, so we use an <code>AtomicReference</code> here as a box.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Kotlin lets you alter mutable variables from callbacks directly, without needing this sort of trick.</p>
</div>
<p>The enclave can provide a <em>routing hint</em> to tell the host where it'd like the message delivered. For example, this
could be set to the value of the <em>from</em> header. It's called a "hint" because the enclave must always remember that
the host is untrusted. It can be arbitrarily malicious and could, for example, not deliver the mail at all, or
it could deliver it to the wrong place. However if it does deliver it wrongly, the encryption will ensure the
bogus recipient can't do anything with the mail. In this simple hello world tutorial we can only handle one client
at once so we're going to ignore the routing hint here. In a more sophisticated server you could provide an 
implementation of <code>EnclaveHost.MailCallbacks</code> that has access to your connected clients, a database, a durable queue,
a <code>ThreadLocal</code> containing a servlet connection and so on. </p>
<p>At the bottom of our main method let's add some code to accept TCP connections and send the <code>EnclaveInstanceInfo</code> to 
whomever connects. Then we'll accept a mail uploaded by the client, send it to the enclave, and deliver the response 
back. We'll write the client code in a moment.</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Listening on port &quot;</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">&quot;. Use the client app to send strings for reversal.&quot;</span><span class="p">);</span>
<span class="n">ServerSocket</span> <span class="n">acceptor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
<span class="n">Socket</span> <span class="n">connection</span> <span class="o">=</span> <span class="n">acceptor</span><span class="p">.</span><span class="na">accept</span><span class="p">();</span>

<span class="c1">// Just send the attestation straight to whoever connects. It&#39;s signed so that&#39;s MITM-safe.</span>
<span class="n">DataOutputStream</span> <span class="n">output</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="p">(</span><span class="n">connection</span><span class="p">.</span><span class="na">getOutputStream</span><span class="p">());</span>
<span class="n">output</span><span class="p">.</span><span class="na">writeInt</span><span class="p">(</span><span class="n">attestationBytes</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="n">output</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">attestationBytes</span><span class="p">);</span>

<span class="c1">// Now read some mail from the client.</span>
<span class="n">DataInputStream</span> <span class="n">input</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="p">(</span><span class="n">connection</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">());</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">mailBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">input</span><span class="p">.</span><span class="na">readInt</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
<span class="n">input</span><span class="p">.</span><span class="na">readFully</span><span class="p">(</span><span class="n">mailBytes</span><span class="p">);</span>

<span class="c1">// Deliver it. The enclave will give us some mail to reply with via the callback we passed in</span>
<span class="c1">// to the start() method.</span>
<span class="n">enclave</span><span class="p">.</span><span class="na">deliverMail</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">mailBytes</span><span class="p">,</span> <span class="s">&quot;routingHint&quot;</span><span class="p">);</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">toSend</span> <span class="o">=</span> <span class="n">mailToSend</span><span class="p">.</span><span class="na">getAndSet</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="n">output</span><span class="p">.</span><span class="na">writeInt</span><span class="p">(</span><span class="n">toSend</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="n">output</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">toSend</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>This code is straightforward. In order, it:</p>
<ol>
<li>Opens a socket using the Java sockets API and listens for a connection.</li>
<li>Accepts a connection and then sends the serialized <code>EnclaveInstanceInfo</code> to the client. We first send the length
   so the client knows how many bytes to read.</li>
<li>The client will send us a byte array back, which contains an encrypted string. This code can't read the body, it's 
   just encrypted bytes except for a few fields in the headers, which <em>are</em> available to the host.</li>
<li>We deliver the encrypted mail bytes to the enclave.</li>
<li>We pick up the response from the <code>AtomicReference</code> box that was set by the callback.</li>
</ol>
<p>The first parameter to <code>deliverMail</code> is a "mail ID" that the enclave can use to
identify this mail to the host. This feature is intended for use with acknowledgement, which allows the enclave to
signal that it's done with that message and the work it represents can be atomically/transactionally completed.
The <em>routing hint</em> is an arbitrary string that can be used to identify the sender of the mail from the host's
perspective, e.g. a connection ID, username, identity - it's up to you. The enclave can use this string to 
signal to the host that a mail should go to that location. It's called a "hint" to remind you that the host code may
be modified or writter by an attacker, so the enclave can't trust it. However, the encryption on the mail makes it 
useless for the host to mis-direct mail.</p>
<div class="admonition todo">
<p class="admonition-title">Todo</p>
<p>In future we will provide APIs to bind enclaves to common transports, to avoid this sort of boilerplate.</p>
</div>
<h2 id="writing-the-client">Writing the client<a class="headerlink" href="#writing-the-client" title="Permanent link">&para;</a></h2>
<p>The client app will do three things:</p>
<ol>
<li>Connect to the host server and download the <code>EnclaveInstanceInfo</code> from it.</li>
<li>Verify the enclave is acceptable: i.e. that it will do what's expected.</li>
<li>Send it the command line arguments as a string to reverse and get back the answer, using encrypted mail.</li>
</ol>
<p>Here's the initial boilerplate to grab the user input, connect, download and deserialize the <code>EnclaveInstanceInfo</code>.</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="p">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="p">,</span> <span class="n">InvalidEnclaveException</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="na">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">System</span><span class="p">.</span><span class="na">err</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Please pass the string to reverse on the command line&quot;</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">String</span> <span class="n">toReverse</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="na">join</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>

        <span class="c1">// Connect to the host, it will send us a remote attestation (EnclaveInstanceInfo).</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">9999</span><span class="p">);</span>
        <span class="n">DataInputStream</span> <span class="n">fromHost</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="na">getInputStream</span><span class="p">());</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">attestationBytes</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">fromHost</span><span class="p">.</span><span class="na">readInt</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
        <span class="n">fromHost</span><span class="p">.</span><span class="na">readFully</span><span class="p">(</span><span class="n">attestationBytes</span><span class="p">);</span>
        <span class="n">EnclaveInstanceInfo</span> <span class="n">attestation</span> <span class="o">=</span> <span class="n">EnclaveInstanceInfo</span><span class="p">.</span><span class="na">deserialize</span><span class="p">(</span><span class="n">attestationBytes</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<h3 id="constraints">Constraints<a class="headerlink" href="#constraints" title="Permanent link">&para;</a></h3>
<p>How do you know the <code>EnclaveInstanceInfo</code> you've got is for the enclave you really intend to interact with? In normal
client/server programming you connect to a host using some sort of identity, like a domain name or IP address. TLS 
is used to ensure the server that picks up is the rightful owner of the domain name you intended to connect to. In
enclave programming the location of the enclave might not matter much because the host is untrusted. Instead you have
to verify <em>what</em> is running, rather than <em>where</em> it's running.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The domain name of the server can still be important in some applications, in which case you should use TLS instead
of raw sockets as is the case here.</p>
</div>
<p>One way to do this is by inspecting the properties on the <code>EnclaveInstanceInfo</code> object and hard-coding some logic. That
works fine, but testing an <code>EnclaveInstanceInfo</code> is a common pattern in enclave programming, so we provide an API to 
do it for you.</p>
<p>The <a href="/api/com/r3/conclave/client/EnclaveConstraint.html"><code>EnclaveConstraint</code></a> class takes an <code>EnclaveInstanceInfo</code> and
performs some matching against it. A constraint object can be built in code, or it can be loaded from a small domain
specific language encoded as a one-line string. The string form is helpful if you anticipate frequent upgrades that
should be whitelisted or other frequent changes to the acceptable enclave, as it can be easily put into a
configuration file, JSON, XML or command line flags.</p>
<p>The constraint lets you specify:</p>
<ol>
<li>Acceptable code hashes (measurements)</li>
<li>Acceptable signing public keys</li>
<li>The minimum revocation level </li>
<li>The product ID</li>
<li>The security level of the instance: <code>SECURE</code>, <code>STALE</code>, <code>INSECURE</code></li>
</ol>
<p>If you specify a signing public key then you must also specify the product ID, otherwise if the organisation that
created the enclave makes a second different kind of enclave in future, a malicious host might connect you with the
wrong one. If the input/output commands are similar then a confusion attack could be opened up. That's why you must
always specify the product ID even if it's zero.</p>
<p>The simplest possible string-form constraint looks like this:</p>
<p><code>C:F86798C4B12BE12073B87C3F57E66BCE7A541EE3D0DDA4FE8853471139C9393F</code></p>
<p>It says "accept exactly one program, with that measurement hash". In this case the value came from the output of the
build process as shown above. This is useful when you don't trust the author nor host of the enclave, and want to
audit the source code and then reproduce the build.</p>
<p>Often that's too rigid. We trust the <em>developer</em> of the enclave, just not the host. In that case we'll accept any enclave
signed by the developer's public key. We can express that by listing code signing key hashes, like this:</p>
<p><code>S:01280A6F7EAC8799C5CFDB1F11FF34BC9AE9A5BC7A7F7F54C77475F445897E3B PROD:1</code></p>
<p>When constraining to a signing key we must also specify the product ID, because a key can be used to sign more than
one product. </p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="c1">// Check it&#39;s the enclave we expect. This will throw InvalidEnclaveException if not valid.</span>
<span class="c1">// The hash here comes from observing what the build printed.</span>
<span class="n">EnclaveConstraint</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="s">&quot;S:01280A6F7EAC8799C5CFDB1F11FF34BC9AE9A5BC7A7F7F54C77475F445897E3B PROD:1 SEC:INSECURE&quot;</span><span class="p">).</span><span class="na">check</span><span class="p">(</span><span class="n">attestation</span><span class="p">);</span>
</code></pre></div>
</td></tr></table>
<p>This line of code parses a simple constraint that says any enclave (even if run in simulation mode) signed by this
hash of a code signing key with product ID of 1 is acceptable. Obviously in a real app, you would remove the part
that says <code>SEC:INSECURE</code>, but it's convenient to have this whilst developing. You'd probably also retrieve the
constraint from a configuration file, system property or command line flag. Finally it uses the <code>check</code> method with
the attestation object. If anything is amiss an exception is thrown, so past this point we know we're talking to the
real <code>ReverseEnclave</code> we wrote earlier.  </p>
<h3 id="keys-and-mail">Keys and mail<a class="headerlink" href="#keys-and-mail" title="Permanent link">&para;</a></h3>
<p>We want to receive a response from the enclave, and we want that to be encrypted/tamperproofed too. That means we
need a key pair of our own. Conclave uses Curve25519, a state of the art elliptic curve algorithm. For reasons of
implementation robustness and avoidance of side channel attacks, this is the only algorithm supported by Conclave Mail.
If you want to use other algorithms for some reason you would need to implement your own messaging system on top of
host-local calls. Alternatively, use that other algorithm to encrypt/decrypt a Curve25519 private key. Generating such
a key is straightforward: </p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="n">KeyPair</span> <span class="n">myKey</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Curve25519KeyPairGenerator</span><span class="p">().</span><span class="na">generateKeyPair</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>Unfortunately the Java Cryptography Architecture only introduced official support for Curve25519 in Java 11. At the
moment in Conclave therefore, you must utilize our <code>Curve25519KeyPairGenerator</code>, <code>Curve25519PublicKey</code> and <code>Curve25519PrivateKey</code>
classes. In future we may offer support for using the Java 11 JCA types directly. A Curve25519 private key is simply
32 random bytes, which you can access using the <code>getEncoded()</code> method on <code>PrivateKey</code>. </p>
<p>Now we have a key with which to receive the response, we create a mail to the enclave. This is done using the
<code>EnclaveInstanceInfo.createMail</code> method, which returns a <code>MutableMail</code> object. We must set our private key on the mail
so it's mixed in to the calculations when the mail is encrypted and thus becomes available in <code>getAuthenticatedSender()</code>
inside the enclave: without the call to <code>setPrivateKey</code> the authenticated sender will be null. This can sometimes be
appropriate, if for example, the enclave already knows the sender's private key via some other mechanism.</p>
<p>The sequence number for this newly created mail is zero. That means if we re-run the program twice we'll try to send
the enclave two mails with the same topic, sender and sequence number. This is invalid: the enclave will reject it as
an apparent replay attack until it's restarted and forgets what mail it received. We could keep a counter on disk and 
increment it, but it's easier to simply set the topic to a random UUID. After that, we can encrypt the mail. </p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="n">MutableMail</span> <span class="n">mail</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="na">createMail</span><span class="p">(</span><span class="n">toReverse</span><span class="p">.</span><span class="na">getBytes</span><span class="p">(</span><span class="n">StandardCharsets</span><span class="p">.</span><span class="na">UTF_8</span><span class="p">));</span>
<span class="n">mail</span><span class="p">.</span><span class="na">setPrivateKey</span><span class="p">(</span><span class="n">myKey</span><span class="p">.</span><span class="na">getPrivate</span><span class="p">());</span>
<span class="c1">// Set a random topic, so we can re-run this program against the same server.</span>
<span class="n">mail</span><span class="p">.</span><span class="na">setTopic</span><span class="p">(</span><span class="n">UUID</span><span class="p">.</span><span class="na">randomUUID</span><span class="p">().</span><span class="na">toString</span><span class="p">());</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">encryptedMail</span> <span class="o">=</span> <span class="n">mail</span><span class="p">.</span><span class="na">encrypt</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>In more complex apps it might be smart to use the topic in more complex ways, like how a web app can use the URL to
separate different functions of the app.</p>
<p>Now we have an encrypted message we can write it to the socket and receive the enclave's response.</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Sending the encrypted mail to the host.&quot;</span><span class="p">);</span>
<span class="n">DataOutputStream</span> <span class="n">toHost</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="na">getOutputStream</span><span class="p">());</span>
<span class="n">toHost</span><span class="p">.</span><span class="na">writeInt</span><span class="p">(</span><span class="n">encryptedMail</span><span class="p">.</span><span class="na">length</span><span class="p">);</span>
<span class="n">toHost</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">encryptedMail</span><span class="p">);</span>

<span class="c1">// Enclave will mail us back.</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">encryptedReply</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="n">fromHost</span><span class="p">.</span><span class="na">readInt</span><span class="p">()</span><span class="o">]</span><span class="p">;</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Reading reply mail of length &quot;</span> <span class="o">+</span> <span class="n">encryptedReply</span><span class="p">.</span><span class="na">length</span> <span class="o">+</span> <span class="s">&quot; bytes.&quot;</span><span class="p">);</span>
<span class="n">fromHost</span><span class="p">.</span><span class="na">readFully</span><span class="p">(</span><span class="n">encryptedReply</span><span class="p">);</span>

<span class="c1">// Decrypt the reply</span>
<span class="n">EnclaveMail</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">attestation</span><span class="p">.</span><span class="na">decryptMail</span><span class="p">(</span><span class="n">encryptedReply</span><span class="p">,</span> <span class="n">myKey</span><span class="p">.</span><span class="na">getPrivate</span><span class="p">());</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Enclave reversed &#39;&quot;</span> <span class="o">+</span> <span class="n">toReverse</span> <span class="o">+</span> <span class="s">&quot;&#39; and gave us the answer &#39;&quot;</span> <span class="o">+</span> <span class="k">new</span> <span class="n">String</span><span class="p">(</span><span class="n">reply</span><span class="p">.</span><span class="na">getBodyAsBytes</span><span class="p">())</span> <span class="o">+</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
<span class="n">socket</span><span class="p">.</span><span class="na">close</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p>We write out the length of the mail, then the mail bytes, then read the length of the response and read the response 
bytes. Finally we use <code>EnclaveInstanceInfo.decryptMail</code>, passing in the encrypted reply we got and our own private key.
This method checks the bytes really did come from that enclave (by checking the authenticated sender key against the
enclave's public key in the attestation), decodes the bytes and yields the reply. We can then access the body of the
message using <code>EnclaveMail.getBodyAsBytes()</code>.</p>
<p>Finally we close the socket, and we're done. Phew! 😅</p>
<h2 id="testing">Testing<a class="headerlink" href="#testing" title="Permanent link">&para;</a></h2>
<p>There are two ways you can test the enclave: as a mock or natively.</p>
<h3 id="mock">Mock<a class="headerlink" href="#mock" title="Permanent link">&para;</a></h3>
<p>The <code>conclave-testing</code> library has a <code>MockHost</code> class which lets you whitebox test your enclave by running the enclave
fully in-memory. There is no need for SGX hardware or a specific OS and thus ideal for cross-platform unit testing. The
underlying enclave object is also exposed enabling you to make assertions on the enclave's state, something that
cannot be done on real hardware or even in simulation mode.</p>
<p>In your enclave module add the following test dependency</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code>    <span class="n">testImplementation</span> <span class="s2">&quot;com.r3.conclave:conclave-testing&quot;</span>
</code></pre></div>
</td></tr></table>
<p>You create your mock enclave by calling <code>MockHost.loadMock</code>.</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="n">MockHost</span><span class="o">&lt;</span><span class="n">ReverseEnclave</span><span class="o">&gt;</span> <span class="n">mockHost</span> <span class="o">=</span> <span class="n">MockHost</span><span class="p">.</span><span class="na">loadMock</span><span class="p">(</span><span class="n">ReverseEnclave</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
<span class="n">mockHost</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
<span class="n">ReverseEnclave</span> <span class="n">reverseEnclave</span> <span class="o">=</span> <span class="n">mockHost</span><span class="p">.</span><span class="na">getEnclave</span><span class="p">();</span>
</code></pre></div>
</td></tr></table>
<p><code>MockHost</code> is a <code>EnclaveHost</code> so you call the enclave as normal with <code>callEnclave</code>. You have direct assess to the
enclave object instance with <code>mockHost.getEnclave()</code>.</p>
<h3 id="native">Native<a class="headerlink" href="#native" title="Permanent link">&para;</a></h3>
<p>Testing the enclave natively is relatively straightforward: the enclave needs to be loaded with <code>EnclaveHost.load</code>. By
default this will run the tests in a simulated environment and will require the correct OS. Native tests are ideal for 
integration testing.</p>
<p>To test the enclave in debug mode on real secure hardware the <code>-PenclaveMode=debug</code> flag needs to be specified and the
SPID and attestation key need to be passed into the test. This can be done with system properties.</p>
<p>In your host module build file:</p>
<table class="groovy codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="groovy codehilite"><pre><span></span><code><span class="n">test</span> <span class="o">{</span>
<span class="hll">    <span class="n">useJUnitPlatform</span><span class="o">()</span>
</span>    <span class="c1">// Pass through any -Pspid and -Pattestation-key parameters to the tests</span>
    <span class="n">systemProperties</span> <span class="n">project</span><span class="o">.</span><span class="na">properties</span><span class="o">.</span><span class="na">subMap</span><span class="o">([</span><span class="s2">&quot;spid&quot;</span><span class="o">,</span> <span class="s2">&quot;attestation-key&quot;</span><span class="o">])</span>
<span class="o">}</span>
</code></pre></div>
</td></tr></table>
<p>Pass these values to <code>EnclaveHost.start</code> in your test:</p>
<table class="java codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="java codehilite"><pre><span></span><code><span class="kd">private</span> <span class="kd">static</span> <span class="n">EnclaveHost</span> <span class="n">enclave</span><span class="p">;</span>

<span class="nd">@BeforeAll</span>
<span class="kd">static</span> <span class="kt">void</span> <span class="nf">startup</span><span class="p">()</span> <span class="kd">throws</span> <span class="n">EnclaveLoadException</span> <span class="p">{</span>
    <span class="n">enclave</span> <span class="o">=</span> <span class="n">EnclaveHost</span><span class="p">.</span><span class="na">load</span><span class="p">(</span><span class="s">&quot;com.r3.conclave.sample.enclave.ReverseEnclave&quot;</span><span class="p">);</span>
    <span class="n">enclave</span><span class="p">.</span><span class="na">start</span><span class="p">(</span><span class="k">new</span> <span class="n">AttestationParameters</span><span class="p">.</span><span class="na">DCAP</span><span class="p">(),</span> <span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
</td></tr></table>
<p><code>gradlew -PenclaveMode=debug host:test</code></p>
<p>Note that native tests are located in the host module while mock tests in the enclave module.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="tutorial.html" title="Compiling and running" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Compiling and running
              </div>
            </div>
          </a>
        
        
          <a href="machine-setup.html" title="Machine setup" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Machine setup
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="assets/javascripts/vendor.d710d30a.min.js"></script>
      <script src="assets/javascripts/bundle.5f27aba8.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents"}</script>
      
      <script>
        app = initialize({
          base: ".",
          features: ["tabs"],
          search: Object.assign({
            worker: "assets/javascripts/worker/search.27c6a5e6.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>